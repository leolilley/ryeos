# rye:signed:2026-02-25T00:02:13Z:7fc8c520e7180ff00b1ba52ae9f7d7212b45002f42b0cba336cccc679364dd7e:1FzG0VdmzIpcH6qWYcIHz0VXNYbuJoTRxfTe-7AJD4zfk8UezzbfBOAjDvutdGUGBXEe_5MTxlsiZWJifxVWDg==:9fbfabe975fa5a7f
# config/hook_conditions.yaml
category: "rye/agent/threads/config"
tool_type: "config"
version: "1.0.0"
description: "Built-in and infrastructure hook definitions for thread lifecycle events"
schema_version: "1.0.0"

builtin_hooks:
  - id: "default_retry_transient"
    event: "error"
    layer: 2
    condition:
      path: "classification.category"
      op: "in"
      value: ["transient", "rate_limited"]
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/control"
      params:
        action: "retry"
    description: "Retry transient and rate-limited errors"

  - id: "default_fail_permanent"
    event: "error"
    layer: 2
    condition:
      path: "classification.category"
      op: "eq"
      value: "permanent"
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/control"
      params:
        action: "fail"
        error: "${error.message}"
    description: "Fail on permanent errors"

  - id: "default_abort_cancelled"
    event: "error"
    layer: 2
    condition:
      path: "classification.category"
      op: "eq"
      value: "cancelled"
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/control"
      params:
        action: "abort"
    description: "Abort on cancellation"

  - id: "default_escalate_limit"
    event: "limit"
    layer: 2
    condition:
      path: "limit_code"
      op: "in"
      value: ["spend_exceeded", "turns_exceeded", "tokens_exceeded", "duration_seconds_exceeded", "spawns_exceeded", "depth_exceeded"]
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/control"
      params:
        action: "escalate"
        limit_type: "${limit_code}"
        current_value: "${current_value}"
    description: "Escalate limit hits for approval"

  - id: "default_context_compaction"
    event: "context_window_pressure"
    layer: 2
    condition:
      path: "pressure_ratio"
      op: "gte"
      value: 0.8
    action:
      primary: "execute"
      item_type: "directive"
      item_id: "rye/agent/threads/default_compaction"
      params:
        pressure_ratio: "${event.pressure_ratio}"
        tokens_used: "${event.tokens_used}"
    description: "Trigger context compaction"

  - id: "default_directive_return"
    event: "directive_return"
    layer: 2
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/emitter"
      params:
        event_type: "directive_return"
        thread_id: "${thread_id}"
        payload:
          outputs: "${outputs}"
          cost: "${cost}"
    description: "Emit directive_return event for observability"

infra_hooks:
  - id: "infra_save_state"
    event: "after_step"
    layer: 3
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/emitter"
      params:
        event_type: "checkpoint_saved"
        thread_id: "${thread_id}"
        payload:
          turn: "${cost.turns}"

  - id: "infra_completion_signal"
    event: "after_complete"
    layer: 3
    action:
      primary: "execute"
      item_type: "tool"
      item_id: "rye/agent/threads/internal/emitter"
      params:
        event_type: "thread_completed"
        thread_id: "${thread_id}"
        payload:
          cost: "${cost}"

context_hooks:
  - id: "system_identity"
    event: "build_system_prompt"
    layer: 2
    position: "before"
    action:
      primary: "load"
      item_type: "knowledge"
      item_id: "rye/agent/core/identity"
    description: "Load agent identity into system prompt"

  - id: "system_behavior"
    event: "build_system_prompt"
    layer: 2
    position: "before"
    action:
      primary: "load"
      item_type: "knowledge"
      item_id: "rye/agent/core/behavior"
    description: "Load behavioral rules into system prompt"

  - id: "system_tool_protocol"
    event: "build_system_prompt"
    layer: 2
    position: "before"
    action:
      primary: "load"
      item_type: "knowledge"
      item_id: "rye/agent/core/tool-protocol"
    description: "Load tool usage protocol into system prompt"

  - id: "ctx_environment"
    event: "thread_started"
    layer: 2
    position: "before"
    action:
      primary: "load"
      item_type: "knowledge"
      item_id: "rye/agent/core/environment"
    description: "Inject runtime environment context into first user message"

  - id: "ctx_completion"
    event: "thread_started"
    layer: 2
    position: "after"
    action:
      primary: "load"
      item_type: "knowledge"
      item_id: "rye/agent/core/completion"
    description: "Inject completion protocol into first user message"

action_primaries: ["execute", "search", "load", "sign"]

action_item_types: ["directive", "tool", "knowledge"]
