tool_id: anthropic_messages
tool_type: http
version: "1.1.0"
description: "Anthropic Messages API â€” system default provider for thread execution"
executor_id: rye/core/primitives/http_client
category: rye/agent/providers

requires:
  - net.call

env_config:
  env:
    ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"

config:
  method: POST
  url: "https://api.anthropic.com/v1/messages"

  auth:
    type: api_key
    key: "${ANTHROPIC_API_KEY}"
    header: x-api-key

  headers:
    Content-Type: application/json
    anthropic-version: "2023-06-01"

  body:
    model: "{model}"
    max_tokens: "{max_tokens}"
    system: "{system_prompt}"
    messages: "{messages}"
    tools: "{tools}"

  timeout: 120

  retry:
    max_attempts: 2
    backoff: exponential

prompts:
  system_template: |
    You are Rye, an automated directive execution agent.
    You accomplish tasks by calling tools via the Anthropic tool_use API.

    RULES
    - You MUST call tools using the tool_use content block. This is non-negotiable.
    - NEVER write tool calls as text, XML, JSON, or code blocks in your response.
    - NEVER fabricate or imagine tool results. Wait for the actual result after each call.
    - Follow the directive steps in order. If a step requires an action, call the appropriate tool.
    - When the directive is complete, respond with a brief summary. Do not call any more tools.
    - If you cannot complete a step, explain why in plain text.

    TOOLS
    You have access to these tools: {tool_names}

    Each tool is called by name with a JSON object as input matching its schema.
    The tool definitions and their input schemas are provided in the API request.

    DIRECTIVE
    Name: {directive_name}
    Description: {directive_description}
    {directive_steps}
    {directive_inputs}

parameters:
  - name: model
    type: string
    required: true
    default: "claude-3-5-haiku-20241022"
  - name: max_tokens
    type: integer
    required: true
    default: 1024
  - name: system_prompt
    type: string
    required: false
    default: ""
  - name: messages
    type: array
    required: true
    description: "Array of {role, content} message objects"
  - name: tools
    type: array
    required: false
    default: []
    description: "Array of tool definitions for function calling"

tool_use:
  tool_definition:
    name: "{name}"
    description: "{description}"
    input_schema: "{schema}"

  response:
    stop_reason_field: stop_reason
    stop_reason_tool_use: tool_use
    content_field: content
    text_block_type: text
    text_field: text
    tool_use_block_type: tool_use
    tool_use_id_field: id
    tool_use_name_field: name
    tool_use_input_field: input

  tool_result:
    role: user
    block_type: tool_result
    id_field: tool_use_id
    content_field: content
    error_field: is_error
